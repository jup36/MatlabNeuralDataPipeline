filePath = '/Volumes/Beefcake/Junchol_Data/JS2.0/WR40_081419'; 
hTrjPath = '/Volumes/dudmanlab/dilucid-drop-output/mouseJoystick3/081419_WR40'; 
kv = load(fullfile(filePath,'jsTime1k_Kinematics_VideoFiles'),'jsTime1k_KV'); 
kv = kv.('jsTime1k_KV');
% load streo-calibration data

allCsv = dir(fullfile(hTrjPath,'*.csv')); % all trial file
fronIdx = find(cell2mat(cellfun(@isstruct, {kv(:).fVideoInfo},'Un',0))==1,1,'first'); 
sideIdx = find(cell2mat(cellfun(@isstruct, {kv(:).sVideoInfo},'Un',0))==1,1,'first'); 


[~,vFolderName] = fileparts(hTrjPath); 
firstFron = VideoReader(fullfile(filePath,vFolderName,S(fronIdx).name)); 
firstFron = VideoReader('/Volumes/Beefcake/Junchol_Data/JS2.0/WR40_081419/081419_WR40/cam0_cam_0_2019_08_14_14_19_01'); 

opts = spreadsheetImportOptions; 
opts.VariableNamesRange = 2;  

fronCnt = 0; % count front cam files
sideCnt = 0; % count side cam files
for t = 1:length(allCsv)
    tmpTrj.FileName = fullfile(allCsv(t).folder,allCsv(t).name);
    tmpCsv = readtable(tmpTrj.FileName);
    tmpCsvCell = table2cell(tmpCsv);
    
    if t == 1
        % locate variables in the csv file
        fg1Idx = cellfun(@(a) strcmpi(a,'Finger1'), tmpCsvCell(1,:));
        fg2Idx = cellfun(@(a) strcmpi(a,'Finger2'), tmpCsvCell(1,:));
        hdIdx = cellfun(@(a) strcmpi(a,'hand'), tmpCsvCell(1,:));
        js1Idx = cellfun(@(a) strcmpi(a,'Joystick1'), tmpCsvCell(1,:));
        js2Idx = cellfun(@(a) strcmpi(a,'Joystick2'), tmpCsvCell(1,:));
        
        xIdx = cellfun(@(a) strcmpi(a,'x'), tmpCsvCell(2,:));
        yIdx = cellfun(@(a) strcmpi(a,'y'), tmpCsvCell(2,:));
        lIdx = cellfun(@(a) strcmpi(a,'likelihood'), tmpCsvCell(2,:));
    end
   
    tmpTrj.fg1X = cellfun(@str2double, tmpCsvCell(3:end,fg1Idx & xIdx)); % finger1 x 
    tmpTrj.fg1Y = cellfun(@str2double, tmpCsvCell(3:end,fg1Idx & yIdx)); % finger1 y
    tmpTrj.fg1lh = cellfun(@str2double, tmpCsvCell(3:end,fg1Idx & lIdx)); % finger1 likelihood
    tmpTrj.fg1IntX = interplh(tmpTrj.fg1X, tmpTrj.fg1lh); 
    tmpTrj.fg2IntY = interplh(); 
    
    tmpTrj.fg2X = cellfun(@str2double, tmpCsvCell(3:end,fg2Idx & xIdx)); % finger2 x
    tmpTrj.fg2Y = cellfun(@str2double, tmpCsvCell(3:end,fg2Idx & yIdx)); % finger2 y
    tmpTrj.fg2lh = cellfun(@str2double, tmpCsvCell(3:end,fg2Idx & lIdx)); % finger2 likelihood
    
    tmpTrj.hdX = cellfun(@str2double, tmpCsvCell(3:end,hdIdx & xIdx)); % hand x
    tmpTrj.hdY = cellfun(@str2double, tmpCsvCell(3:end,hdIdx & yIdx)); % hand y
    tmpTrj.hdlh = cellfun(@str2double, tmpCsvCell(3:end,hdIdx & lIdx)); % hand likelihood  
    
    if contains(tmpTrj.FileName,'cam0','IgnoreCase',true)
        fronCnt = fronCnt + 1; 
        fron(fronCnt) = tmpTrj;
    elseif contains(tmpTrj.FileName,'cam1','IgnoreCase',true)
        sideCnt = sideCnt + 1; 
        side(sideCnt) = tmpTrj;
    end   
    

% pairwise distance fg1, fg2, hand

fprintf('processed file #%d\n', t);
end

fronFg1Fig2Dist = cell2mat(cellfun(@(a,b,c,d) sqrt((a-b).^2+(c-d).^2), {fron(:).fg1X}, {fron(:).fg2X}, {fron(:).fg1Y}, {fron(:).fg2Y},'Un',0)'); % front, point-by-point distance between two fingers
fronFg1hdDist = cell2mat(cellfun(@(a,b,c,d) sqrt((a-b).^2+(c-d).^2), {fron(:).fg1X}, {fron(:).hdX}, {fron(:).fg1Y}, {fron(:).hdY},'Un',0)'); % front, point-by-point distance between two fingers


function  trj = interplh(trj,trjlh)
% interpolates a timeseries (trj) based on it's likelihood (trjlh)  
intTrj = nan(length(trj),1); 
x = 1:length(trj);
trj(trjlh<.2)=nan;

if sum(isnan(trj(end-4:end)))==0
%trjwnan = trj; 
%figure; hold on; 
trj(isnan(trj)) = interp1(x(~isnan(trj)),trj(~isnan(trj)),x(isnan(trj)),'spline');
%plot(trj)
%plot(trjwnan)
%hold off; 
intTrj = trj;  
end

end


tr = 182;
figure; 
plot(fron(tr).fg1X, fron(tr).fg1Y)
figure; 
plot(side(tr).fg1X, side(tr).fg1Y)

figure; 
plot(fron(tr).fg2X, fron(tr).fg2Y)
figure; 
plot(side(tr).fg2X, side(tr).fg2Y)

figure; 
plot(fron(tr).hdX, fron(tr).hdY)
figure; 
plot(side(tr).hdX, side(tr).hdY)
trj   = side(tr).fg2X; 
trjlh = side(tr).fg2lh; 


   
%    [tmpPath,tmpName,tmpExt] = fileparts(tmpTrj.FileName); 
%    find(cellfun(@(s) contains(s,tmpName(strfind(tmpName,'2019'):end)), {allCsv(:).name})==1)


